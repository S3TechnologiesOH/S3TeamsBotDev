"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * Created by kgrube on 4/3/2019
 */
const util_1 = require("util");
const isPromise = util_1.types.isPromise;
/**
 *
 * @param options - options object
 * @param options.series - functions or promises to be executed
 * @param options.concurrent - number of concurrent requests
 * @param options.delay - number of ms between request groups
 * @returns array of promise results
 * @public
 *
 * @example
 * ```javascript
 *    const results = await Series.all({
 *      series: [
 *        () => true,
 *        new Promise((resolve) => resolve(true),
 *        () => new Promise((resolve) => resolve(true)
 *      ],
 *      concurrent: 3,
 *      delay: 10,
 *    })
 * ```
 */
function all({ series = [], concurrent = 1, delay = 0 }) {
    const promises = series.slice();
    const concurrency = concurrent;
    let results = null;
    return new Promise((resolve, reject) => {
        function next(result) {
            const concurrentPromises = [];
            if (!results) {
                results = [];
            }
            else {
                results = results.concat(result);
            }
            if (promises.length) {
                while (concurrentPromises.length < concurrency && promises.length) {
                    let promise = promises.shift();
                    if (typeof promise === 'function') {
                        promise = promise();
                    }
                    if (!promise || !isPromise(promise)) {
                        promise = Promise.resolve(promise);
                    }
                    concurrentPromises.push(promise);
                }
                setTimeout(() => Promise.all(concurrentPromises).then(next).catch(reject), delay);
            }
            else {
                resolve(results);
            }
        }
        next();
    });
}
/**
 * @public
 */
const Series = { all };
exports.default = Series;
//# sourceMappingURL=Series.js.map